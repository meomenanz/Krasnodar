<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>KRASNODAR RP: HARDCORE</title>
    <style>
        :root { --main: #007bff; --panel: #1e1e1e; }
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Arial', sans-serif; color: white; user-select: none; }
        canvas { display: block; }

        /* –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã */
        .overlay { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.8); z-index: 100; }
        .window { background: var(--panel); padding: 30px; border-radius: 20px; border: 2px solid var(--main); text-align: center; width: 350px; pointer-events: auto; }
        
        button { width: 100%; padding: 12px; margin-top: 10px; background: var(--main); border: none; color: #fff; font-weight: bold; border-radius: 8px; cursor: pointer; }
        input { width: 90%; padding: 12px; margin: 10px 0; background: #000; border: 1px solid #444; color: #fff; border-radius: 8px; }

        /* HUD */
        #hud { position: absolute; top: 20px; right: 20px; text-align: right; pointer-events: none; }
        .money-text { font-size: 28px; color: #00ff00; font-weight: bold; }
        .hp-bar-bg { width: 200px; height: 15px; background: #440000; border: 1px solid #000; }
        #hp-fill { width: 100%; height: 100%; background: #ff3333; transition: 0.2s; }

        /* –ß–∞—Ç */
        #chat-box { position: absolute; top: 20px; left: 20px; width: 400px; height: 180px; background: rgba(0,0,0,0.5); padding: 10px; border-radius: 10px; overflow: hidden; display: flex; flex-direction: column-reverse; pointer-events: none; font-size: 14px; border: 1px solid rgba(255,255,255,0.1); }
        #chat-input { position: absolute; top: 210px; left: 20px; width: 380px; display: none; background: #111; color: #fff; border: 2px solid var(--main); padding: 10px; pointer-events: auto; }

        /* –¢–µ–ª–µ—Ñ–æ–Ω */
        #phone { position: absolute; right: 40px; bottom: -500px; width: 200px; height: 350px; background: #111; border: 4px solid #333; border-radius: 25px; transition: 0.4s; padding: 15px; z-index: 90; display: flex; flex-direction: column; }
        #phone.active { bottom: 30px; }

        #hint { position: absolute; bottom: 100px; left: 50%; transform: translateX(-50%); color: yellow; font-weight: bold; display: none; }
        
        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ */
        #mic-status { position: absolute; bottom: 20px; left: 20px; color: #00ff00; font-weight: bold; display: none; text-shadow: 1px 1px #000; }
    </style>
</head>
<body>

<div id="ui-layer">
    <div class="overlay" id="screen-auth">
        <div class="window">
            <h1>KRASNODAR RP</h1>
            <input type="text" id="reg-nick" placeholder="–í–∞—à –Ω–∏–∫">
            <button onclick="toServers()">–í–û–ô–¢–ò</button>
        </div>
    </div>

    <div class="overlay" id="screen-factions" style="display:none;">
        <div class="window">
            <h2>–í–´–ë–ï–†–ò–¢–ï –°–¢–û–†–û–ù–£</h2>
            <button style="background: #e74c3c;" onclick="startGame('–û–ü–ì')">–û–ü–ì (–ö—Ä–∏–º–∏–Ω–∞–ª)</button>
            <button style="background: #3498db;" onclick="startGame('–ú–í–î')">–ú–í–î (–ó–∞–∫–æ–Ω)</button>
        </div>
    </div>

    <div class="overlay" id="screen-shop" style="display:none;">
        <div class="window">
            <h2>–û–†–£–ñ–ï–ô–ù–ê–Ø</h2>
            <p>–ë–∞–ª–∞–Ω—Å: <span id="shop-money">0</span>‚ÇΩ</p>
            <button onclick="buyItem('–ù–æ–∂', 100)">–ö—É–ø–∏—Ç—å –ù–æ–∂ (100‚ÇΩ)</button>
            <button onclick="buyItem('–ë—Ä–æ–Ω–µ–∂–∏–ª–µ—Ç', 500)">–ë—Ä–æ–Ω–µ–∂–∏–ª–µ—Ç (500‚ÇΩ)</button>
            <button style="background:#555;" onclick="closeShop()">–í–´–•–û–î</button>
        </div>
    </div>

    <div id="game-ui" style="display:none;">
        <div id="chat-box"></div>
        <input type="text" id="chat-input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
        
        <div id="hud">
            <div id="ui-nick">Player</div>
            <div class="money-text"><span id="ui-money">0</span> ‚ÇΩ</div>
            <div class="hp-bar-bg"><div id="hp-fill"></div></div>
        </div>

        <div id="phone">
            <h4 style="text-align:center;margin:5px;">SAMSUNG</h4>
            <button onclick="alert('–í–∞—à–∞ —Ñ—Ä–∞–∫—Ü–∏—è: '+p.team)">–ò–Ω—Ñ–æ</button>
            <button onclick="location.reload()" style="background:#c0392b;">–í—ã–π—Ç–∏</button>
            <button style="margin-top:auto; background:#444;" onclick="togglePhone()">–ó–ê–ö–†–´–¢–¨</button>
        </div>
        <div id="hint">–ù–∞–∂–º–∏—Ç–µ [E] —á—Ç–æ–±—ã –∑–∞–π—Ç–∏</div>
        <div id="mic-status">üé§ –ú–ò–ö–†–û–§–û–ù –í–ö–õ–Æ–ß–ï–ù (X)</div>
    </div>
</div>

<canvas id="game"></canvas>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, onDisconnect, update as dbUpdate } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyApfEncKdafvvXaUmtTclPiDJPyrcuD7SQ",
        authDomain: "greenpay-34957.firebaseapp.com",
        projectId: "greenpay-34957",
        databaseURL: "https://greenpay-34957-default-rtdb.firebaseio.com/",
        storageBucket: "greenpay-34957.firebasestorage.app",
        messagingSenderId: "990792295519",
        appId: "1:990792295519:web:5ba691f1f8eb896db8a7ea"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä–æ–∫–∞
    window.p = { 
        x: 500, y: 500, nick: '', team: '', hp: 100, money: 0, 
        color: '', active: false, chat: false, phone: false,
        talking: false // –ù–æ–≤–æ–µ –ø–æ–ª–µ –¥–ª—è –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
    };
    let players = {};
    let localStream = null;

    const WORLD = {
        w: 3000, h: 2000,
        opg_base: {x: 100, y: 100, w: 300, h: 200, color: '#4d1a1a', name: '–ë–ê–ó–ê –û–ü–ì'},
        mvd_base: {x: 2500, y: 100, w: 400, h: 300, color: '#1a1a4d', name: '–£–í–î'},
        shop: {x: 1400, y: 1400, w: 200, h: 150, color: '#4d4d1a', name: '–ú–ê–ì–ê–ó–ò–ù'}
    };

    // --- –°–∏—Å—Ç–µ–º–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ ---
    async function initMicrophone() {
        try {
            localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            localStream.getAudioTracks()[0].enabled = false; 
        } catch (e) { console.error("–ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω"); }
    }

    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è HTML
    window.toServers = () => {
        p.nick = document.getElementById('reg-nick').value;
        if(!p.nick) return alert("–ù–∏–∫!");
        initMicrophone(); // –ó–∞–ø—Ä–æ—Å –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –ø—Ä–∏ –≤—Ö–æ–¥–µ
        document.getElementById('screen-auth').style.display = 'none';
        document.getElementById('screen-factions').style.display = 'flex';
        
        onValue(ref(db, 'players'), (s) => { 
            players = s.val() || {};
            if(players[p.nick] && players[p.nick].hp <= 0 && p.hp > 0) {
                die();
            }
        });
        
        onValue(ref(db, 'chat'), (s) => {
            const chatBox = document.getElementById('chat-box');
            chatBox.innerHTML = '';
            const msgs = s.val() || {};
            Object.values(msgs).slice(-8).forEach(m => {
                const div = document.createElement('div');
                div.innerHTML = `<b style="color:${m.c}">${m.n}:</b> ${m.t}`;
                chatBox.prepend(div);
            });
        });
    };

    window.startGame = (team) => {
        p.team = team;
        p.color = team === '–û–ü–ì' ? '#ff4d4d' : '#3498db';
        p.x = team === '–û–ü–ì' ? 250 : 2700;
        p.active = true;
        document.getElementById('screen-factions').style.display = 'none';
        document.getElementById('game-ui').style.display = 'block';
        document.getElementById('ui-nick').innerText = p.nick;
        onDisconnect(ref(db, 'players/' + p.nick)).remove();
        loop();
    };

    window.togglePhone = () => {
        p.phone = !p.phone;
        document.getElementById('phone').classList.toggle('active', p.phone);
    };

    window.closeShop = () => { document.getElementById('screen-shop').style.display = 'none'; };
    window.buyItem = (item, price) => {
        if(p.money >= price) {
            p.money -= price;
            addChatMsg("–°–∏—Å—Ç–µ–º–∞", `–ö—É–ø–ª–µ–Ω–æ: ${item}`, "#ffff00");
        } else alert("–ú–∞–ª–æ –¥–µ–Ω–µ–≥!");
    };

    function addChatMsg(n, t, c) {
        const msgRef = ref(db, 'chat/' + Date.now());
        set(msgRef, { n, t, c });
    }

    window.onmousedown = () => {
        if(!p.active || p.chat || p.phone) return;
        for(let id in players) {
            if(id === p.nick) continue;
            let target = players[id];
            let dist = Math.hypot(p.x - target.x, p.y - target.y);
            if(dist < 60) {
                let newHp = (target.hp || 100) - 10;
                dbUpdate(ref(db, 'players/' + id), { hp: newHp });
                addChatMsg("–ë–æ–π", `${p.nick} —É–¥–∞—Ä–∏–ª ${id}`, "#ff0000");
            }
        }
    };

    function die() {
        p.hp = 100;
        p.x = p.team === '–û–ü–ì' ? 250 : 2700;
        p.y = 500;
        addChatMsg("–ú–û–†–ì", `${p.nick} –ø–æ–≥–∏–± –∏ —Ä–µ—Å–ø–∞–≤–Ω–∏–ª—Å—è`, "#fff");
    }

    const keys = {};
    window.onkeydown = (e) => {
        keys[e.code] = true;
        // –ö–Ω–æ–ø–∫–∞ X –¥–ª—è –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
        if(e.code === 'KeyX' && localStream && !p.chat) {
            p.talking = true;
            localStream.getAudioTracks()[0].enabled = true;
            document.getElementById('mic-status').style.display = 'block';
        }
        if(e.code === 'KeyT' && !p.chat) {
            p.chat = true;
            const input = document.getElementById('chat-input');
            input.style.display = 'block'; setTimeout(()=>input.focus(), 10);
        }
        if(e.code === 'Enter' && p.chat) {
            const input = document.getElementById('chat-input');
            if(input.value) addChatMsg(p.nick, input.value, p.color);
            input.value = ''; input.style.display = 'none'; p.chat = false;
        }
        if(e.code === 'KeyE') {
            if(Math.hypot(p.x - (WORLD.shop.x + 100), p.y - (WORLD.shop.y + 75)) < 150) {
                document.getElementById('screen-shop').style.display = 'flex';
                document.getElementById('shop-money').innerText = p.money;
            }
        }
        if(e.code === 'Tab') { e.preventDefault(); togglePhone(); }
    };

    window.onkeyup = (e) => {
        keys[e.code] = false;
        if(e.code === 'KeyX' && localStream) {
            p.talking = false;
            localStream.getAudioTracks()[0].enabled = false;
            document.getElementById('mic-status').style.display = 'none';
        }
    };

    function update() {
        if(!p.active || p.chat) return;
        if(keys['KeyW']) p.y -= 6; if(keys['KeyS']) p.y += 6;
        if(keys['KeyA']) p.x -= 6; if(keys['KeyD']) p.x += 6;

        p.x = Math.max(0, Math.min(WORLD.w, p.x));
        p.y = Math.max(0, Math.min(WORLD.h, p.y));

        document.getElementById('ui-money').innerText = p.money;
        document.getElementById('hp-fill').style.width = p.hp + '%';
        
        let nearShop = Math.hypot(p.x - (WORLD.shop.x + 100), p.y - (WORLD.shop.y + 75)) < 150;
        document.getElementById('hint').style.display = nearShop ? 'block' : 'none';

        set(ref(db, 'players/' + p.nick), {
            x: p.x, y: p.y, color: p.color, hp: p.hp, team: p.team, talking: p.talking
        });
    }

    function draw() {
        const canvas = document.getElementById('game');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        
        const camX = canvas.width/2 - p.x;
        const camY = canvas.height/2 - p.y;
        
        ctx.save();
        ctx.translate(camX, camY);

        ctx.fillStyle = '#1e3d1e'; ctx.fillRect(0,0, WORLD.w, WORLD.h);

        [WORLD.opg_base, WORLD.mvd_base, WORLD.shop].forEach(b => {
            ctx.fillStyle = b.color; ctx.fillRect(b.x, b.y, b.w, b.h);
            ctx.strokeStyle = '#fff'; ctx.lineWidth = 4; ctx.strokeRect(b.x, b.y, b.w, b.h);
            ctx.fillStyle = '#fff'; ctx.font = 'bold 20px Arial';
            ctx.fillText(b.name, b.x + 20, b.y + 40);
        });

        for(let id in players) {
            if(id === p.nick) continue;
            let pl = players[id];
            ctx.fillStyle = pl.color;
            ctx.fillRect(pl.x - 25, pl.y - 25, 50, 50);
            
            // –ï—Å–ª–∏ –∏–≥—Ä–æ–∫ –≥–æ–≤–æ—Ä–∏—Ç –∏ –æ–Ω –≤ —Ä–∞–¥–∏—É—Å–µ 550 –ø–∏–∫—Å–µ–ª–µ–π (55 —Å–º)
            let dist = Math.hypot(p.x - pl.x, p.y - pl.y);
            if(pl.talking && dist < 550) {
                ctx.strokeStyle = '#00ff00';
                ctx.lineWidth = 3;
                ctx.strokeRect(pl.x - 30, pl.y - 30, 60, 60);
            }

            ctx.fillStyle = '#fff'; ctx.textAlign = 'center';
            ctx.fillText(id + ` (${pl.hp}%)`, pl.x, pl.y - 35);
        }

        ctx.restore();

        ctx.fillStyle = p.color;
        ctx.fillRect(canvas.width/2 - 25, canvas.height/2 - 25, 50, 50);
        ctx.strokeStyle = 'white'; ctx.strokeRect(canvas.width/2 - 25, canvas.height/2 - 25, 50, 50);
        
        // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä "–ì–æ–≤–æ—Ä—é" –Ω–∞–¥ —Å–≤–æ–µ–π –≥–æ–ª–æ–≤–æ–π
        if(p.talking) {
            ctx.fillStyle = '#00ff00';
            ctx.fillText("üé§", canvas.width/2, canvas.height/2 - 40);
        }
    }

    function loop() { update(); draw(); requestAnimationFrame(loop); }
</script>
</body>
</html>
